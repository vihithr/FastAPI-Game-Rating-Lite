我会先快速扫一遍工程目录结构，锁定主要后端/前端/脚本模块，然后读取关键文件（如入口文件、路由、模型、脚本）来推断功能点，最后为你生成一个结构化的功能说明 Markdown 文档。过程中我会尽量自动完成所有分析，你只需要在最后查看文档是否符合预期。

[19 tools called]

下面是一份基于当前代码结构整理的功能统计与分析文档（Markdown 格式），你可以直接保存为 `PROJECT_OVERVIEW.md` 之类的文件使用。

---

## STG 社区站工程功能总览

**项目名称**：STG 社区站 / STG Community Hub（独立部署版）  
**技术栈**：FastAPI + SQLAlchemy + Jinja2 + SQLite（默认）  
**主要用途**：面向 STG/弹幕射击玩家的评分与社区网站，支持游戏条目、品质评分与难度评分、评论、悬赏板块、资源索引、文章系统等。

---

## 1. 目录与模块结构

- **`app/main.py`**  
  - 创建 `FastAPI` 应用实例。  
  - 初始化数据库表：`models.Base.metadata.create_all(bind=database.engine)`。  
  - 初始化悬赏板块预设分类（`BountyCategory`）一次性写入。  
  - 挂载静态资源目录 `/static`（统一从 `BASE_DIR/app/static` 提供）。  
  - 配置 `SessionMiddleware`，使用 Cookie 维持会话。  
  - 中间件解码 JWT，把当前用户模型挂到 `request.state.user`，供模板使用。  
  - 注册全部路由模块：
    - `authentication`（登录注册）
    - `pages`（首页/游戏列表/统计/详情/用户主页）
    - `api`（前端用 JSON API）
    - `ratings`（评分接口）
    - `admin`（管理端接口）
    - `articles`（文章与静态专题）
    - `bounties`（悬赏板块）
    - `password_reset`（密码重置）
    - `resources`（资源索引系统）
  - 健康检查端点：`GET /health`。

- **`app/config/constants.py`**  
  - `BASE_DIR`：项目根目录。  
  - `MAX_TAGS_DISPLAY`：浏览页面标签显示上限。  
  - 邮件/站点配置：`SITE_BASE_URL`、邮件服务器、账号等（用于密码重置等）。

- **`app/config/templates.py`**  
  - 配置 `Jinja2Templates`，统一模板目录 `app/templates`。

- **`app/static`**  
  - `css/style.css`：全站样式。  
  - `js/*.js`：3D 卡片、游戏详情交互、表单交互、主题切换等前端脚本。  
  - `uploads/`：文章图片与游戏/资源封面上传目录。  
  - `articles/`：文章静态包解压后的静态资源。  
  - `vendor/`：第三方前端库，如 Chart.js、datalabels 插件、图标库。

- **`app/templates`**  
  - 页面模板列表（仅列出主要功能关联的）：
    - 站点基础：`base.html`、`home.html`、`index.html`
    - 用户认证：`login.html`、`register.html`
    - 游戏系统：`browse_games.html`、`game_details.html`、`add_game.html`、`edit_game.html`
    - 评分统计：`difficulty_stats.html`
    - 用户主页：`user_profile.html`
    - 悬赏系统：`bounties_list.html`、`bounty_detail.html`、`bounty_form.html`
    - 文章系统：`articles_list.html`、`article_detail.html`、`article_form.html`
    - 资源系统：`resources_list.html`、`resource_detail.html`、`resource_submit.html`
    - 密码重置：`password_reset_request*.html`、`password_reset_form.html` 等

- **部署与运维相关**  
  - `deploy.sh`：一键部署 / 更新 / 卸载脚本。  
  - `Caddyfile`：反向代理与 HTTPS 模板。  
  - `stg_website.service`：Systemd 服务单元模板。  
  - `gunicorn_config.py`：Gunicorn 配置。  
  - `alembic/`：数据库迁移。  
  - 文档：`README.md`、`DEPLOYMENT.md`、`DEPLOY_CHECKLIST.md`、`CONTRIBUTING.md`。

---

## 2. 核心数据模型与领域对象

**文件：`app/models.py`**

- **用户与认证**
  - `User`
    - 字段：`username`、`email`、`hashed_password`、`is_admin`、`created_at`。  
    - 关系：`comments`、`bounties`、`bounty_comments`、`resources`。
  - `PasswordResetToken`
    - 用户密码重置令牌（`token` + `expires_at`）。

- **游戏与评分体系**
  - 多对多关联：
    - `game_tag_association`：`Game` ↔ `Tag`。
  - 核心模型：
    - `Game`
      - 字段：`title`、`company`、`description`、`image_url`、`created_by`。  
      - 关系：`comments`、`quality_ratings`、`difficulty_ratings`、`tags`、`aliases`、`translations`、`difficulty_levels`、`ship_types`。
    - `Tag`
      - 游戏标签（独立表，支持多对多复用）。
    - `Alias` / `Translation`
      - 游戏别名 / 译名（1:N）。  
    - `DifficultyLevel`
      - 某个游戏内的难度等级（如 Normal/Hard/ex）。  
    - `ShipType`
      - 某个游戏内的机体/角色种类。
    - `Comment`
      - 游戏评论（与 `Game` 和 `User` 关联）。
    - `QualityRating`
      - 品质评分：
        - 维度：趣味性 `fun`、核心设计 `core`、深度 `depth`、演出 `performance`、剧情 `story`。  
        - 带时间戳 `created_at`。
    - `DifficultyRating`
      - 难度评分：
        - 维度：避弹 `dodge`、策略 `strategy`、执行 `execution`。  
        - 绑定到特定 `(difficulty_level_id, ship_type_id)` 情境。  
        - 也有 `created_at`。

- **文章系统**
  - `Article`
    - 字段：`title`、`slug`、`content_md`、`content_html`、`status`、`author_id`、`static_path`、时间戳。  
    - 支持**纯 Markdown 文章**与**纯静态包文章**（仅 `static_path`）两种形式。

- **悬赏系统**
  - 多对多：`bounty_tag_association`：`Bounty` ↔ `BountyTag`。  
  - `BountyCategory`
    - 悬赏板块类型（如技术求助 / 资源征集 / 合作邀请 / 游戏悬赏 / 其他）。  
  - `BountyTag`
    - 悬赏标签，独立于游戏标签。  
  - `Bounty`
    - 字段：`title`、`content`、`reward`、`game_name`、`category_id`、`created_by`、`contact_info`、完成状态与时间、时间戳。  
    - 关系：`creator`、`category`、`bounty_tags`、`comments`。
  - `BountyComment`
    - 悬赏评论，与 `Bounty` 和 `User` 关联。

- **资源索引系统**
  - 多对多：`resource_tag_association`：`Resource` ↔ `ResourceTag`。  
  - `ResourceTag`
    - 资源标签（与游戏/悬赏标签彻底隔离）。  
  - `Resource`
    - 字段：
      - `title`、`content`（正文含链接/提取码）、`intro`（简介）、`cover_image`、`category`、`status`（valid/invalid）、`heat`（热度）、`uploader_id`、`created_at`。  
    - 关系：`uploader`（User）、`tags`（ResourceTag）。  
  - `ResourceVote`
    - 用户对资源的投票（顶 or 踩），每个用户对每个资源只允许一条记录（唯一约束），`value` 为 1 或 -1。

---

## 3. 认证与权限功能

**文件：`app/auth.py`、`app/routers/authentication.py`**

- **密码与 JWT**
  - 使用 `passlib.CryptContext`，支持 `bcrypt_sha256` + `bcrypt`，解决 72 字节限制兼容问题。  
  - `SECRET_KEY`、JWT 算法、过期时间通过环境变量配置。  
  - 提供：
    - `get_password_hash` / `verify_password`  
    - `create_access_token`  
    - `get_user` / `authenticate_user`

- **认证方式**
  - 自定义 `CookieOrBearerAuth`：
    - 优先从 `Cookie["access_token"]` 中读取 JWT；  
    - 无则回退到 `Authorization: Bearer` 头。  
  - `get_current_user`：统一解码 JWT 并从数据库返回 `User`。  
  - `get_current_admin_user`：在 `get_current_user` 基础上校验 `is_admin`。

- **登录/注册/登出**
  - `GET /register`：显示注册表单。  
  - `POST /register`：保存新用户，用户名唯一校验。  
  - `GET /login`：显示登录表单。  
  - `POST /login`：
    - 验证用户名密码；  
    - 生成 JWT，写入 `access_token` Cookie；  
    - 在 `request.session` 存储 `user_id`。  
  - `GET /logout`：
    - 清空 session，删除 `access_token` Cookie。

---

## 4. 游戏浏览与详情功能

**文件：`app/routers/pages.py`**

- **首页 `GET /`**
  - 最近添加的游戏（按 ID 倒序，限制数量），附带标签。  
  - 热门游戏榜：
    - 至少 3 条品质评分的游戏；  
    - 计算五个品质维度平均后的总体分数；  
    - 按平均分倒序排序。  
  - 平台统计：
    - 总游戏数、总品质评分数、总难度评分数、总用户数。  
  - 热门标签：
    - 使用频率最高的游戏标签（基于多对多表计数）。  
  - 最新评论：
    - 最近若干条游戏评论，带游戏与作者信息。

- **游戏列表 `GET /games`**
  - 支持：
    - 按标签筛选（单标签 `tag` 或多标签 `tags=a,b,c`）。  
    - 按公司 `company` 筛选。  
    - 分页：`page`、`per_page`（限制最大 100）。  
  - 多标签筛选策略：游戏必须包含所有指定标签（通过交集过滤）。  
  - 页面附带：
    - 全部公司列表（去重、排序）。  
    - 使用频次最高的标签（数量上限 `MAX_TAGS_DISPLAY`）。  
    - 当前标签/公司/分页信息。

- **难度统计页面 `GET /stats`**
  - 遍历所有游戏与其难度评分、难度等级、机体类型。  
  - 按 `(difficulty_level_id, ship_type_id)` 分组，计算：
    - 三个难度维度平均值  
    - 综合平均分  
    - 评分数量  
    - 对应“段位描述”（见 `get_difficulty_realm`）  
  - 提供筛选用的数据集：所有游戏、所有难度等级、所有机体、标签列表、公司列表。  
  - 用于前端绘制可视化统计（Chart.js）。

- **游戏详情 `GET /game/{game_id}`**
  - 使用 `selectinload` 一次性加载：
    - 评论、标签、别名、译名、难度等级、机体、所有评分。  
  - 通过 `get_game_evaluation(game)` 汇总：
    - 品质评分各维度 + 总体分 + 评论列表；  
    - 按情境分组的难度评级和段位；  
    - 整体难度平均分与段位。  
  - 如果用户已登录：
    - 加载该用户对本游戏的品质评分和难度评分（按情境分组），用于前端高亮/预填。

- **游戏添加与编辑**
  - `GET /add-game`：显示添加游戏表单（需登录）。  
  - `POST /add-game`：
    - 校验封面图片大小（≤1MB）与格式（JPEG/PNG/GIF/WebP）；  
    - 生成唯一文件名，保存到 `/static/uploads/covers`；  
    - 创建 `Game`，并通过辅助函数处理：
      - 标签 `process_tags`：以自定义分隔符 `|~|` 解析，复用已有 `Tag`，新建未存在的。  
      - 多个一对多列表 `process_one_to_many`：别名、译名、难度等级、机体类型等。  
  - `GET /game/{game_id}/edit`：编辑表单，仅创建者或管理员可访问。  
  - `POST /game/{game_id}/update`：
    - 权限检查：创建者或管理员。  
    - 可更新封面图片（自动删除旧文件）。  
    - 更新公司、标题、描述、标签、别名、译名、难度等级、机体类型等。

---

## 5. 评分与评论系统

**文件：`app/routers/ratings.py`、`app/utils/ratings.py`**

- **品质评分 `POST /game/{game_id}/rate_quality`**
  - 从表单中读取每个维度的星级（字段名形如 `rating_趣味性`）。  
  - 若用户之前有评分则更新，否则新建 `QualityRating`。  
  - 提交后返回：
    - 各维度最新平均值与参与人数。  
    - 总体评分（五维取平均再对所有评分求平均）。

- **撤销品质评分 `DELETE /game/{game_id}/rate_quality`**
  - 删除当前用户的对应 `QualityRating`。  
  - 返回最新聚合数据和更新后的总体分。

- **难度评分 `POST /game/{game_id}/rate_difficulty`**
  - 支持按特定情境评分：`difficulty_level_id` + `ship_type_id`（允许为 `None` 表示总体/全机体）。  
  - 与品质类似，存在则更新，否则创建 `DifficultyRating`。  
  - 返回当前情境下的统计数据：
    - 每个难度维度的平均值、段位、计数；  
    - 情境综合平均值、总评分数。

- **撤销难度评分 `DELETE /game/{game_id}/rate_difficulty`**
  - 根据查询参数 `difficulty_level_id` / `ship_type_id` 定位情境，删除当前用户对应记录。  
  - 返回：
    - 当前情境后的更新数据；  
    - 游戏整体难度评分汇总。

- **评论（在 `pages.py` 中与 `Comment` 模型配合使用）**
  - 游戏评论在游戏详情中展示，由前端表单 + `Comment` 模型支持。  
  - API 侧（`app/routers/api.py`）提供评论增删改接口，以便前端异步更新。

---

## 6. 悬赏系统功能

**文件：`app/routers/bounties.py`**

- **悬赏列表 `GET /bounties`**
  - 可按：
    - 板块（`category_id`）  
    - 状态（全部/进行中/已完成：`status_filter`）  
  - 联合加载创建者、板块、悬赏标签、评论。  
  - 附带板块列表供前端筛选。

- **创建悬赏**
  - `GET /bounty/new`：登录用户可访问的创建表单。  
  - `POST /bounty/new`：
    - 校验板块存在；  
    - 填写标题、正文、奖励说明、可选游戏名、联系方式、板块、标签；  
    - 标签以 `|~|` 分隔，复用或创建 `BountyTag` 并绑定到 `Bounty`。

- **悬赏详情 `GET /bounty/{bounty_id}`**
  - 展示悬赏内容、板块、创建者、标签、评论。  
  - 基于 `request.state.user` 计算当前用户是否是发布者 / 管理员，从而决定是否显示编辑按钮。

- **编辑/删除/完成**
  - 编辑表单/更新接口：只有创建者或管理员可以操作。  
  - 删除接口：同样权限限制。  
  - 标记完成接口：设置 `is_completed` 与 `completed_at`。

- **悬赏评论**
  - `POST /bounty/{bounty_id}/comment`：登录用户可评论，不能为空。

---

## 7. 文章与静态专题系统

**文件：`app/routers/articles.py`**

- Markdown 渲染：
  - 使用 `markdown` + `bleach`（如果安装），支持代码块和表格，带 XSS 过滤。  
  - 支持图片上传到 `/static/uploads/articles`。  

- 静态包支持：
  - 接收 zip 静态包，解压至 `/static/articles/{slug}/`，清空旧内容。  
  - 若文章只有 `static_path` 且无正文，则访问 `/article/{slug}` 时自动重定向至 `index.html` 或静态目录。

- 管理操作（管理员权限）：
  - `GET /admin/articles/new`：创建表单。  
  - `POST /admin/articles/new`：创建文章（Markdown + 可选静态包）。  
  - `GET /admin/articles/{id}/edit` / `POST /admin/articles/{id}/edit`：编辑文章。  
  - `POST /admin/articles/{id}/delete`：删除文章。  
  - `POST /admin/articles/preview`：Ajax 预览 Markdown → HTML。  
  - `POST /admin/articles/upload_image` / `upload_static`：富文本编辑器辅助接口。

- 公开页面：
  - `GET /articles`：文章列表（只显示 `status="published"`）。  
  - `GET /article/{slug}`：文章详情或跳转到静态内容。  
  - `GET /article/{slug}/static`：静态包入口重定向。

---

## 8. 资源索引系统功能

**文件：`app/routers/resources.py`**

- **资源列表 `GET /resources/`**
  - 仅展示 `status="valid"` 的资源。  
  - 支持：
    - 关键词搜索（标题 + 标签名，模糊匹配）；  
    - 单标签过滤（`tag`）；  
    - 分页。  
  - 排序规则：按 `heat`（热度）降序，然后按创建时间降序。  
  - 计算热门标签（只基于资源标签），用于侧边栏展示。  
  - 提供建议分类枚举（如 游戏本体 / 补丁 / OST / DLC / 工具 / 攻略/文档 / 其他）。

- **资源提交与编辑**
  - `GET /resources/submit`：登录用户可访问的提交页面。  
  - `POST /resources/submit`：
    - 校验标题、分类、标签、正文均非空；  
    - 支持上传封面图（同样大小/格式限制）；  
    - 处理标签字符串（中英文逗号与空白分隔），复用或创建 `ResourceTag`。  
  - `GET /resources/{id}/edit` / `POST /resources/{id}/edit`：
    - 仅上传者或管理员可编辑；  
    - 允许更新标题、分类、标签、正文、简介、封面。

- **资源详情 `GET /resources/{id}`**
  - 展示资源信息、标签、上传者，以及当前用户对该资源的投票状态（如已顶/已踩）。

- **资源投票**
  - `POST /resources/{id}/vote`
    - `direction` 为 `"up"` 或 `"down"`；  
    - 每人每资源一条记录，重复同向投票为 no-op；  
    - 反向投票会调整 `heat`（热度）并更新记录。  
    - 返回当前热度与投票状态。

- **资源删除**
  - `POST /resources/{id}/delete`
    - 仅上传者或管理员可操作；  
    - 物理删除资源记录（如需改为逻辑删除，可根据注释改写为 `status='invalid'`）。

---

## 9. 管理端功能

**文件：`app/routers/admin.py`**

- 路径前缀：`/admin`，全部接口必须通过 `get_current_admin_user` 鉴权。

- 功能：
  - 删除任意评论：`DELETE /admin/comment/{comment_id}`。  
  - 删除整个游戏：`DELETE /admin/game/{game_id}`：
    - 删除封面图片文件；  
    - 删除相关 `QualityRating` 和 `DifficultyRating`；  
    - 删除 `Game` 本身（级联删除评论等）。  
  - 清理无引用标签：`POST /admin/cleanup-orphaned-tags`  
    - 找出未被任何游戏使用的标签并删除，返回统计信息。

---

## 10. API 接口（前端异步与工具使用）

**文件：`app/routers/api.py`**

- 前缀：`/api/v1`，标签：`API`。

- 已实现功能（节选）：
  - `GET /api/v1/games`：
    - 返回所有游戏的简要信息（`id`, `title`, `company`, `image_url`，标签和别名列表），供前端浏览页异步加载。  
  - 评论相关：
    - `POST /api/v1/games/{game_id}/comments`：登录用户添加评论。  
    - `PUT /api/v1/comments/{comment_id}`：作者本人更新评论。  
    - `DELETE /api/v1/comments/{comment_id}`：作者或管理员删除评论。  
  - 用户在某游戏的评分：
    - `GET /api/v1/games/{game_id}/my-ratings`：返回该用户对该游戏的品质评分和全部难度评分（按情境分组）。

---

## 11. 部署与运维特性

**文件：`README.md`、`DEPLOYMENT.md`、`deploy.sh` 等**

- 一键部署脚本 `deploy.sh`：
  - 支持从 GitHub 拉取或从本地压缩包/目录安装。  
  - 自动：
    - 创建专用系统用户 `stg_website`；  
    - 安装 Python 依赖、创建虚拟环境；  
    - 初始化 SQLite 数据库；  
    - 生成 `.env` 并写入随机密钥、站点 URL 和邮件配置；  
    - 配置并启用 Systemd 服务与 Caddy 反向代理。  

- 服务管理：
  - `systemctl status/start/stop/restart stg_website.service`。  
  - 日志查看：`journalctl -u stg_website.service -f`。  

- 卸载：
  - `./deploy.sh uninstall`，可选择是否删除数据目录、服务用户等。

---

## 12. 总结：系统整体能力

- **社区维度**
  - 用户注册登录、游戏评论、游戏评分（品质 + 难度）、用户个人评分档案页。  
- **数据组织**
  - 游戏条目拥有标签、别名、译名、难度等级、机体类型，以及细粒度的评分与统计。  
- **扩展功能**
  - 悬赏板块（带分类、标签、评论、状态流转）。  
  - 文章/专题系统（Markdown + 静态包），适合长文档或专题站。  
  - 资源索引与投票系统，为外部资源（游戏本体/补丁/OST 等）做独立索引与热度排序。  
- **管理能力**
  - 管理员可清理评论、删除游戏及数据、维护标签、发布/编辑文章、管理资源。  
- **运维与部署**
  - 面向生产环境的一键部署与服务管理流程，配合 Caddy 自动 HTTPS 与 Systemd 运行。

如果你希望，我也可以在这份文档基础上再补充一节「接口清单（包含 URL / 方法 / 权限要求）」或「数据表字段详细对照表」。