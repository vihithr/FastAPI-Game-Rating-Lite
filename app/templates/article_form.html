{% extends "base.html" %}

{% block title %}{% if article %}编辑文章{% else %}新建文章{% endif %}{% endblock %}

{% block content %}
<h2><i data-lucide="file-text"></i> {% if article %}编辑文章{% else %}新建文章{% endif %}</h2>

<form id="article-form" action="{% if article %}/admin/articles/{{ article.id }}/edit{% else %}/admin/articles/new{% endif %}" method="post" enctype="multipart/form-data" style="display: flex; flex-direction: column; gap: 1rem;">
    <div>
        <label>
            标题
            <input type="text" name="title" value="{{ article.title if article else '' }}" required>
        </label>
        <label>
            {% if not article %}自定义 slug（可选，不填自动由标题生成）{% else %}slug{% endif %}
            <input type="text" name="slug" placeholder="例如: stg-manual" value="{{ article.slug if article else '' }}" {% if article %}readonly{% endif %}>
        </label>
        {% if article %}
        <input type="hidden" name="slug_current" value="{{ article.slug }}">
        {% endif %}
    </div>

    <div>
        <fieldset>
            <legend>内容模式</legend>
            <label><input type="radio" name="content_mode" value="text" {% if not article or (article and not article.static_path) %}checked{% endif %}> 纯文本</label>
            <label><input type="radio" name="content_mode" value="static" {% if article and article.static_path and not article.content_md %}checked{% endif %}> 纯静态包</label>
            <label><input type="radio" name="content_mode" value="mixed" {% if article and article.static_path and article.content_md %}checked{% endif %}> 混合（文本+静态）</label>
        </fieldset>
    </div>

    <div id="editor-block">
        <label>
            正文（Markdown / 所见即所得）
            <textarea name="content_md" rows="12" placeholder="支持 Markdown" id="content-md" style="display:none;">{{ article.content_md if article else '' }}</textarea>
            <div id="editor-wrapper" style="position: relative;">
                <div id="editor-root"></div>
                <button type="button" id="editor-exit" class="secondary outline editor-exit-btn" style="display:none;">退出全屏</button>
            </div>
        </label>
        <div class="grid" style="margin-top: 0.25rem; grid-template-columns: repeat(auto-fit, minmax(120px, auto)); gap: 0.5rem;">
            <button type="button" id="preview-btn" class="secondary outline">预览 Markdown</button>
            <button type="button" id="editor-grow" class="secondary outline">放大编辑区</button>
            <button type="button" id="editor-shrink" class="secondary outline">缩小编辑区</button>
            <button type="button" id="editor-fullscreen" class="secondary outline">全屏/退出全屏</button>
        </div>
    </div>

    <div id="static-block">
        <label>
            静态包上传（zip，可选，50MB 内）
            <input type="file" name="static_package" accept=".zip">
            {% if article and article.static_path %}
            <small>当前静态资源路径：<a href="{{ article.static_path }}" target="_blank">{{ article.static_path }}</a></small>
            {% endif %}
        </label>
        <progress id="upload-progress" value="0" max="100" style="width: 100%; display: none;"></progress>
        <small id="upload-hint" style="color: var(--pico-muted-color); display: block; margin-top: 0.25rem;">大文件如被 Nginx 拒绝(413)，需增大 client_max_body_size。</small>
    </div>

    <div style="display:flex; gap: 0.5rem; flex-wrap: wrap;">
        <button type="submit">{% if article %}保存{% else %}创建{% endif %}</button>
        <a href="{% if article %}/article/{{ article.slug }}{% else %}/articles{% endif %}" role="button" class="secondary outline">返回</a>
    </div>
</form>

<section id="preview-section" style="margin-top: 1rem; display: none;">
    <header><strong>预览</strong></header>
    <div id="preview-html" style="padding: 1rem; border: 1px solid var(--pico-muted-border-color); border-radius: var(--pico-border-radius);"></div>
</section>

<details style="margin-top: 1rem;">
    <summary role="button" class="secondary">格式说明</summary>
    <ul>
        <li>正文支持 Markdown，保存时会渲染为 HTML。</li>
        <li>静态包请上传 zip，解压后会放到 /static/articles/{slug}/ 下，如包含 index.html，可直接访问。</li>
        <li>如遇 413 Request Entity Too Large，请在 nginx 配置中调大 client_max_body_size（如 20m）。</li>
    </ul>
</details>

<link rel="stylesheet" href="https://uicdn.toast.com/editor/latest/toastui-editor.min.css">
<script src="https://uicdn.toast.com/editor/latest/toastui-editor-all.min.js"></script>
<style>
.editor-fullscreen {
    position: fixed !important;
    z-index: 9999;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: var(--pico-card-background-color);
    padding: 1rem;
}
.editor-fullscreen #editor-root {
    height: calc(100vh - 140px) !important;
}
.editor-exit-btn {
    position: fixed;
    top: 12px;
    right: 12px;
    z-index: 10001;
}
</style>
<script>
(() => {
    const form = document.getElementById('article-form');
    const previewBtn = document.getElementById('preview-btn');
    const previewSection = document.getElementById('preview-section');
    const previewHtml = document.getElementById('preview-html');
    const progressBar = document.getElementById('upload-progress');
    const contentMd = document.getElementById('content-md');
    const staticInput = form?.querySelector('input[type="file"][name="static_package"]');
    const modeRadios = form?.querySelectorAll('input[name="content_mode"]');
    const editorBlock = document.getElementById('editor-block');
    const staticBlock = document.getElementById('static-block');
    const editorWrapper = document.getElementById('editor-wrapper');
    const exitBtn = document.getElementById('editor-exit');
    const btnGrow = document.getElementById('editor-grow');
    const btnShrink = document.getElementById('editor-shrink');
    const btnFullscreen = document.getElementById('editor-fullscreen');
    let editorInstance = null;
    let editorHeight = 500;
    let isFullscreen = false;

    function initEditor() {
        if (!window.toastui || !toastui.Editor) return;
        editorInstance = new toastui.Editor({
            el: document.querySelector('#editor-root'),
            height: '500px',
            initialEditType: 'wysiwyg',
            previewStyle: 'vertical',
            initialValue: contentMd.value || '',
            hooks: {
                addImageBlobHook: async (blob, callback) => {
                    const fd = new FormData();
                    fd.append('file', blob);
                    try {
                        const resp = await fetch('/admin/articles/upload_image', { method: 'POST', body: fd });
                        const data = await resp.json();
                        if (!resp.ok) throw new Error(data.detail || '上传失败');
                        callback(data.url, blob.name);
                    } catch (e) {
                        alert(e.message || '图片上传失败');
                    }
                }
            }
        });
    }

    function applyHeight() {
        if (editorInstance) {
            editorInstance.setHeight(editorHeight + 'px');
        }
    }

    function toggleFullscreen() {
        isFullscreen = !isFullscreen;
        if (isFullscreen) {
            editorWrapper.classList.add('editor-fullscreen');
            editorHeight = window.innerHeight - 120;
            applyHeight();
            if (exitBtn) exitBtn.style.display = 'inline-flex';
        } else {
            editorWrapper.classList.remove('editor-fullscreen');
            editorHeight = 500;
            applyHeight();
            if (exitBtn) exitBtn.style.display = 'none';
        }
    }

    function syncMode() {
        const mode = Array.from(modeRadios || []).find(r => r.checked)?.value || 'text';
        if (editorBlock) editorBlock.style.display = (mode === 'static') ? 'none' : 'block';
        if (staticBlock) staticBlock.style.display = (mode === 'text') ? 'none' : 'block';
    }
    modeRadios?.forEach(r => r.addEventListener('change', syncMode));
    syncMode();

    if (previewBtn) {
        previewBtn.addEventListener('click', async () => {
            const fd = new FormData();
            const mdText = editorInstance ? editorInstance.getMarkdown() : (contentMd?.value || '');
            fd.append('content_md', mdText);
            previewBtn.setAttribute('aria-busy', 'true');
            try {
                const resp = await fetch('/admin/articles/preview', { method: 'POST', body: fd });
                const data = await resp.json();
                previewHtml.innerHTML = data.html || '';
                previewSection.style.display = 'block';
            } catch (e) {
                previewHtml.innerHTML = '<p style="color: var(--pico-color-red-500);">预览失败</p>';
                previewSection.style.display = 'block';
            } finally {
                previewBtn.removeAttribute('aria-busy');
            }
        });
    }

    // 调整高度
    btnGrow?.addEventListener('click', () => {
        editorHeight = Math.min(editorHeight + 200, 2000);
        applyHeight();
    });
    btnShrink?.addEventListener('click', () => {
        editorHeight = Math.max(editorHeight - 200, 300);
        applyHeight();
    });
    btnFullscreen?.addEventListener('click', () => {
        toggleFullscreen();
    });
    exitBtn?.addEventListener('click', () => {
        if (isFullscreen) toggleFullscreen();
    });
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && isFullscreen) {
            toggleFullscreen();
        }
    });

    // 静态包独立上传，成功后写 hidden 并提交表单
    if (form && progressBar && staticInput) {
        form.addEventListener('submit', (e) => {
            if (editorInstance && contentMd) contentMd.value = editorInstance.getMarkdown();
            const selectedMode = Array.from(modeRadios || []).find(r => r.checked)?.value || 'text';
            const hasFile = staticInput.files && staticInput.files.length > 0;

            // 纯文本模式不处理静态包
            if (selectedMode === 'text') {
                if (staticInput) staticInput.value = '';
                return;
            }

            if (!hasFile) return; // 无文件走默认

            e.preventDefault();
            const fd = new FormData();
            const slugInput = form.querySelector('input[name="slug"]');
            const slugCurrent = form.querySelector('input[name="slug_current"]');
            const titleInput = form.querySelector('input[name="title"]');
            fd.append('slug', slugCurrent?.value || slugInput?.value || titleInput?.value || 'article');
            fd.append('static_package', staticInput.files[0]);

            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/admin/articles/upload_static');
            xhr.upload.onprogress = (event) => {
                if (event.lengthComputable) {
                    progressBar.style.display = 'block';
                    progressBar.value = (event.loaded / event.total) * 100;
                }
            };
            xhr.onload = () => {
                if (xhr.status >= 200 && xhr.status < 300) {
                    const resp = JSON.parse(xhr.responseText);
                    let hiddenStatic = form.querySelector('input[name="static_path"]');
                    if (!hiddenStatic) {
                        hiddenStatic = document.createElement('input');
                        hiddenStatic.type = 'hidden';
                        hiddenStatic.name = 'static_path';
                        form.appendChild(hiddenStatic);
                    }
                    hiddenStatic.value = resp.static_path;
                    staticInput.value = '';
                    form.submit();
                } else {
                    alert('静态包上传失败: ' + (xhr.responseText || xhr.statusText));
                }
            };
            xhr.onerror = () => alert('网络错误，上传失败');
            xhr.send(fd);
        });
    } else if (form) {
        // 无静态包时，提交前回填 Markdown
        form.addEventListener('submit', () => {
            if (editorInstance && contentMd) contentMd.value = editorInstance.getMarkdown();
        });
    }

    initEditor();
    applyHeight();
})();
</script>
{% endblock %}

