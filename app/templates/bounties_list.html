{% extends "base.html" %}

{% block title %}悬赏 - STG社区评价{% endblock %}

{% block content %}
<h2><i data-lucide="award"></i> 悬赏</h2>

{% if request.state.user %}
<p><a href="/bounty/new" role="button" class="contrast outline">发布悬赏</a></p>
{% else %}
<p><small>请<a href="/login">登录</a>后发布悬赏</small></p>
{% endif %}

<!-- 筛选器 -->
<div style="margin-bottom: 1.5rem;">
    <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
        <!-- 板块筛选 -->
        <div>
            <label for="category-filter">板块筛选：</label>
            <select id="category-filter" onchange="filterBounties()">
                <option value="">全部板块</option>
                {% for cat in categories %}
                <option value="{{ cat.id }}" {% if current_category_id == cat.id %}selected{% endif %}>
                    {{ cat.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        
        <!-- 状态筛选 -->
        <div>
            <label for="status-filter">状态筛选：</label>
            <select id="status-filter" onchange="filterBounties()">
                <option value="all" {% if current_status == "all" %}selected{% endif %}>全部</option>
                <option value="active" {% if current_status == "active" %}selected{% endif %}>进行中</option>
                <option value="completed" {% if current_status == "completed" %}selected{% endif %}>已完成</option>
            </select>
        </div>
    </div>
</div>

<!-- 悬赏列表 -->
{% if bounties %}
<div class="grid bounties-list" style="grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
    {% for bounty in bounties %}
    <article class="card" style="border: 1px solid var(--pico-card-border-color); padding: 1rem; border-radius: var(--pico-border-radius); height: 100%; display: flex; flex-direction: column; gap: 0.5rem; {% if bounty.is_completed %}opacity: 0.7;{% endif %}">
        <div style="display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap;">
            <a href="/bounty/{{ bounty.id }}" style="font-weight: 700; font-size: 1.05rem; flex: 1;">
                {{ bounty.title }}
            </a>
            {% if bounty.is_completed %}
            <span style="color: var(--pico-success); font-size: 0.9rem;">
                <i data-lucide="check-circle"></i> 已完成
            </span>
            {% else %}
            <span style="color: var(--pico-primary); font-size: 0.9rem;">
                <i data-lucide="clock"></i> 进行中
            </span>
            {% endif %}
        </div>
        
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
            <span class="tag-badge">{{ bounty.category.name }}</span>
            <span style="color: var(--pico-primary); font-weight: 600;">
                <i data-lucide="gift"></i> {{ bounty.reward }}
            </span>
            {% if bounty.game_name %}
            <span style="color: var(--pico-secondary-foreground); font-size: 0.9rem;">
                <i data-lucide="gamepad-2"></i> {{ bounty.game_name }}
            </span>
            {% endif %}
        </div>
        
        {% if bounty.bounty_tags %}
        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 0.25rem;">
            {% for tag in bounty.bounty_tags %}
            <span class="tag-badge" style="font-size: 0.8rem;">{{ tag.name }}</span>
            {% endfor %}
        </div>
        {% endif %}
        
        <p style="color: var(--pico-muted-color); margin: 0; flex: 1;">
            {{ bounty.content[:100] }}{% if bounty.content|length > 100 %}...{% endif %}
        </p>
        
        <div style="margin-top: auto; display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; color: var(--pico-muted-color);">
            <span>
                <i data-lucide="user"></i> <a href="/user/{{ bounty.creator.id }}">{{ bounty.creator.username }}</a>
            </span>
            <span>
                <i data-lucide="message-circle"></i> {{ bounty.comments|length }} 条评论
            </span>
            <span>{{ bounty.created_at.strftime('%Y-%m-%d') }}</span>
        </div>
    </article>
    {% endfor %}
</div>
{% else %}
<p>暂无悬赏{% if current_category_id or current_status != "all" %}（请尝试调整筛选条件）{% endif %}。</p>
{% endif %}

<script>
function filterBounties() {
    const categoryId = document.getElementById('category-filter').value;
    const status = document.getElementById('status-filter').value;
    
    let url = '/bounties?';
    if (categoryId) {
        url += `category_id=${categoryId}&`;
    }
    if (status !== 'all') {
        url += `status_filter=${status}&`;
    }
    
    window.location.href = url.replace(/&$/, '');
}
</script>
{% endblock %}

{% block scripts %}
<script>
    lucide.createIcons();
</script>
{% endblock %}

