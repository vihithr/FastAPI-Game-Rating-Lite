{% extends "base.html" %}

{% block title %}{{ resource.title }} - èµ„æºè¯¦æƒ…{% endblock %}

{% block content %}
<section aria-labelledby="resource-title">
  <!-- é¡¶éƒ¨ä¿¡æ¯ï¼ˆå°é¢ + å…ƒæ•°æ®åœ¨åŒä¸€å±‚ï¼‰ -->
  <article style="padding: 1rem 1.25rem; border-radius:.75rem; border:1px solid var(--pico-muted-border-color); background: color-mix(in srgb, var(--pico-background-color) 90%, var(--pico-muted-border-color));">
    <!-- é¡¶éƒ¨ï¼šæ ‡é¢˜ + å³ä¸Šè§’è¿”å›æŒ‰é’® -->
    <header style="display:flex; justify-content:space-between; align-items:center; gap:.75rem; margin-bottom:.75rem; flex-wrap:wrap;">
      <h2 id="resource-title" style="margin:0;">{{ resource.title }}</h2>
      <a href="/resources" class="secondary outline" role="button" style="white-space:nowrap;">â† è¿”å›åˆ—è¡¨</a>
    </header>

    <div class="grid" style="gap:1.5rem; align-items:flex-start;">
      {% if resource.cover_image %}
        <aside>
          <figure style="max-width: 260px; margin: 0;">
            <img src="{{ resource.cover_image }}" alt="èµ„æºå°é¢" style="width:100%; border-radius: .75rem;">
          </figure>
        </aside>
      {% endif %}

      <div>
        <p style="margin:0; font-size:.9rem;">
          ä¸Šä¼ è€…ï¼š
          {% if resource.uploader %}
            <a href="/user/{{ resource.uploader.id }}">{{ resource.uploader.username }}</a>
          {% else %}
            <span>å·²åˆ é™¤ç”¨æˆ·</span>
          {% endif %}
        </p>
        <p style="margin:.25rem 0; font-size:.9rem;">
          åˆ†ç±»ï¼š<strong>{{ resource.category }}</strong>
          {% if resource.created_at %}
            Â· ä¸Šä¼ äº {{ resource.created_at.strftime("%Y-%m-%d %H:%M") }}
          {% endif %}
        </p>
        <p style="margin:.25rem 0; font-size:.9rem;">
          çŠ¶æ€ï¼š
          {% if resource.status == "valid" %}
            <span class="badge">ğŸŸ¢ æœ‰æ•ˆ</span>
          {% else %}
            <span class="badge secondary outline">ğŸ”´ å¤±æ•ˆ</span>
          {% endif %}
          Â· çƒ­åº¦ï¼š<strong id="resource-heat">{{ resource.heat }}</strong>
        </p>
        <p style="margin-top:.5rem; font-size:.85rem;">
          <span>æ ‡ç­¾ï¼š</span>
          {% for tag in resource.tags %}
            <a href="/resources?tag={{ tag.name | urlencode }}" class="secondary outline" style="margin-right:.25rem; font-size:.75rem;">
              {{ tag.name }}
            </a>
          {% else %}
            <small>æ— æ ‡ç­¾</small>
          {% endfor %}
        </p>
      </div>
    </div>
  </article>

  <!-- ç¬¬äºŒå±‚ï¼šæ“ä½œåŒºï¼ˆé¡¶/è¸© + ç¼–è¾‘åˆ é™¤å›¾æ ‡ï¼‰ -->
  <section aria-label="æ“ä½œåŒº" style="margin-top:1rem;">
    {% if request.state.user %}
      <div style="display:flex; gap:.75rem; flex-wrap:wrap;">
        <!-- å››ä¸ªå¹¶åˆ—æŒ‰é’®ï¼šç»Ÿä¸€è§†è§‰é£æ ¼ï¼Œç°åº¦ç•¥æœ‰åŒºåˆ« -->
        <form id="vote-up-form" method="post" action="/resources/{{ resource.id }}/vote" style="flex:1 1 150px;">
          <input type="hidden" name="direction" value="up">
          <button type="submit"
                  class="secondary"
                  style="width:100%; filter:brightness(1.05);">
            ğŸ‘ é¡¶ä¸€ä¸‹
          </button>
        </form>

        <form id="vote-down-form" method="post" action="/resources/{{ resource.id }}/vote" style="flex:1 1 150px;">
          <input type="hidden" name="direction" value="down">
          <button type="submit"
                  class="secondary"
                  style="width:100%; filter:brightness(0.98);">
            ğŸ‘ å¤±æ•ˆ/æœ‰é—®é¢˜
          </button>
        </form>

        {% if request.state.user.is_admin or request.state.user.id == resource.uploader_id %}
          <form method="get"
                action="/resources/{{ resource.id }}/edit"
                style="flex:1 1 140px;">
            <button type="submit"
                    class="secondary"
                    title="ç¼–è¾‘"
                    style="width:100%; filter:brightness(1.0);">
              âœï¸ ç¼–è¾‘
            </button>
          </form>
          <form method="post"
                action="/resources/{{ resource.id }}/delete"
                style="flex:1 1 140px;"
                onsubmit="return confirm('ç¡®å®šåˆ é™¤è¯¥èµ„æºå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€');">
            <button type="submit"
                    class="secondary"
                    title="åˆ é™¤"
                    style="width:100%; filter:brightness(0.9);">
              ğŸ—‘ åˆ é™¤
            </button>
          </form>
        {% endif %}
      </div>
    {% else %}
      <small>ç™»å½•åå¯ä»¥å¯¹èµ„æºè¿›è¡Œé¡¶/è¸©åé¦ˆã€‚</small>
    {% endif %}
  </section>

  <!-- ç¬¬ä¸‰å±‚ï¼šå†…å®¹ï¼ˆæ•´è¡Œå æ»¡ï¼‰ -->
  <section style="margin-top:1.5rem;">
    {% if resource.intro %}
      <section style="margin-bottom:1rem;">
        <h3>èµ„æºä»‹ç»</h3>
        <p style="white-space: pre-wrap;">{{ resource.intro }}</p>
      </section>
    {% endif %}

    <section>
      <h3>æäº¤å†…å®¹</h3>
      <div style="white-space: pre-wrap; padding:.75rem 1rem; border-radius:.5rem; border:1px solid var(--pico-muted-border-color); background-color: var(--pico-muted-border-color, rgba(0,0,0,0.03));">
        {{ resource.content | urlize(target="_blank", rel="noopener") }}
      </div>
    </section>
  </section>
</section>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
  // ç®€å•çš„ AJAX æŠ•ç¥¨ï¼ˆé¿å…æ•´é¡µåˆ·æ–°ï¼‰
  (function() {
    function bindVote(formId) {
      const form = document.getElementById(formId);
      if (!form) return;
      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        const formData = new FormData(form);
        try {
          const resp = await fetch(form.action, {
            method: 'POST',
            body: formData,
          });
          if (!resp.ok) return;
          const data = await resp.json();
          if (typeof data.heat !== 'undefined') {
            const heatEl = document.getElementById('resource-heat');
            if (heatEl) heatEl.textContent = data.heat;
          }
        } catch (err) {
          console.error('æŠ•ç¥¨å¤±è´¥', err);
        }
      });
    }
    bindVote('vote-up-form');
    bindVote('vote-down-form');
  })();
</script>
{% endblock %}



